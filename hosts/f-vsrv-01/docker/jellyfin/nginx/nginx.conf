events {
    worker_connections 1024;
}

http {
    # Get real IP from Traefik
    set_real_ip_from 172.16.0.0/12;  # Docker network
    real_ip_header X-Forwarded-For;
    real_ip_recursive on;

    # Define LAN IP ranges (specific first, then default)
    geo $is_lan_ip {
        127.0.0.1 1;
        172.16.0.0/12 1;
        192.168.1.0/24 1;
        default 0;
    }

    # Rate limit only for non-LAN IPs
    map $is_lan_ip $limit_rate {
        0 6m;  # Non-LAN IPs get 6MB/s
        1 0;   # LAN IPs get unlimited
    }

    map $is_lan_ip $limit_rate_after {
        0 40m;  # Non-LAN IPs get 40MB burst - good for 1080p initial buffering
        1 0;    # LAN IPs get unlimited
    }

    client_max_body_size 20M;

    proxy_buffers 16 4k;
    proxy_buffer_size 4k;
    proxy_busy_buffers_size 8k;
    proxy_temp_file_write_size 8k;
    proxy_max_temp_file_size 16k;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Add log format with rate limit info and IPs
    log_format rate_limit '[$time_local] "ip=$remote_addr <- $realip_remote_addr '
                         'is_lan=$is_lan_ip rate=$limit_rate burst_after=$limit_rate_after" '
                         'proxy_forwarded_for=$proxy_add_x_forwarded_for http_forwarded_for=$http_x_forwarded_for forwarded_host=$http_host '
                         'request="$request" status="$status" bytes_send="$body_bytes_sent" referer="$http_referer" agent="$http_user_agent"';

    server {
        listen 80;

        location / {
            proxy_buffering on;

            # Apply rate limits based on IP type
            limit_rate $limit_rate;
            limit_rate_after $limit_rate_after;

            # Enable access logging with rate limit format
            access_log /var/log/nginx/jellyfin-access.log rate_limit;

            proxy_pass http://jellyfin:8096;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $http_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Protocol $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
        }

        # required for admin dashboard showing transcoding information
        location /socket {
            # Proxy Jellyfin Websockets traffic
            proxy_pass http://jellyfin:8096;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $http_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Protocol $scheme;
            proxy_set_header X-Forwarded-Host $http_host;
        }
    }
}
