services:
  nextcloud-db:
    image: postgres:17
    container_name: nextcloud-db
    restart: always
    volumes:
      - ./db:/var/lib/postgresql/data
    environment:
      TZ: $TZ
      POSTGRES_USER: $DB_USER
      POSTGRES_PASSWORD: $DB_PW
      POSTGRES_DB: $DB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${DB} -U ${DB_USER} "]
      start_period: 10s
      interval: 30s
      timeout: 10s
      retries: 3

  nextcloud-redis:
    image: redis:latest
    container_name: nextcloud-redis
    restart: always
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ./redis:/data
    command: redis-server --appendonly yes --requirepass $REDIS_PW --maxmemory 512mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD-SHELL",  "echo 'auth ${REDIS_PW}\nping' | redis-cli | grep PONG"]
      start_period: 10s
      interval: 30s
      timeout: 10s
      retries: 3

  nextcloud:
    image: nextcloud:stable
    container_name: nextcloud
    hostname: nextcloud
    restart: always
    volumes:
      - ./config:/var/www/html
      - ./data:/var/www/html/data
      - ./logs:/var/log
    environment:
      TZ: $TZ
      REDIS_HOST: nextcloud-redis
      REDIS_HOST_PASSWORD: $REDIS_PW
      POSTGRES_HOST: nextcloud-db
      POSTGRES_DB: $DB
      POSTGRES_USER: $DB_USER
      POSTGRES_PASSWORD: $DB_PW
    labels:
      traefik.enable: true
      traefik.http.routers.nextcloud-rtr.entrypoints: https
      traefik.http.routers.nextcloud-rtr.rule: Host(`$NEXTCLOUD_HOST.$DOMAIN`)
      traefik.http.middlewares.middlewares-nextcloud-redirect.redirectregex.regex: ^/.well-known/(cal|card)dav
      traefik.http.middlewares.middlewares-nextcloud-redirect.redirectregex.replacement: /remote.php/dav/
      traefik.http.routers.nextcloud-rtr.middlewares: chain-no-auth@file,middlewares-nextcloud-redirect
      traefik.http.routers.nextcloud-rtr.service: nextcloud-svc
      traefik.http.services.nextcloud-svc.loadbalancer.server.port: 80
    depends_on:
      nextcloud-db:
        condition: service_healthy
      nextcloud-redis:
        condition: service_healthy
    networks:
      - proxy
      - default
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost/status.php | grep '\"installed\":true'"]
      start_period: 10s
      interval: 30s
      timeout: 10s
      retries: 3

  nextcloud-collabora:
    image: collabora/code:latest
    container_name: nextcloud-collabora
    restart: always
    environment:
      TZ: $TZ
      aliasgroup1: https://$NEXTCLOUD_HOST.$DOMAIN
      dictionaries: de_DE,en_US
      username: $COLLAB_USER
      password: $COLLAB_PW
      DONT_GEN_SSL_CERT: YES
      extra_params: --o:ssl.enable=false --o:ssl.termination=true
    labels:
      traefik.enable: true
      traefik.http.routers.collab-rtr.entrypoints: https
      traefik.http.routers.collab-rtr.rule: Host(`$COLLAB_HOST.$DOMAIN`)
      traefik.http.routers.collab-rtr.middlewares: chain-no-auth@file
      taefik.http.routers.collab-rtr.service: collab-svc
      traefik.http.services.collab-svc.loadbalancer.server.port: 9980
    networks:
      - proxy
      - default
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9980 | grep OK"]
      start_period: 10s
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  proxy:
    external: true
