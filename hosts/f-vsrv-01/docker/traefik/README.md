# floit - selfhosted

## Traefik

### Description
Traefik is an open source reverse proxy and ingress controller.
https://traefik.io/

### Folderstructure
| Folder | Purpose |
|---|---|
| ~/docker/traefik | folder for traefik |
| ~/docker/traefik/.env | env file for secrets |
| ~/docker/traefik/traefik-compose.yml | docker compose file |
| ~/docker/traefik/setup-files | folder for custom files, which are not used from docker |
| ~/docker/traefik/data | data folder |
| ~/docker/traefik/config/static | folder for static configuration files |
| ~/docker/traefik/config/dynamic/app-<service name>.yml | dynamic configuration file |
| ~/docker/traefik/logs | logs folder |

### Setup
#### Overview
Because of the independent hosts I'm running the Docker environment on, I'm also using static configuration files next to Docker labels. I'm using two wildcard certificate, one for *.domain and one for *.local.domain - generated by Cloudflare. The traefik dashboard is protected by Authentik (Middleware: chain-authentik-auth).

#### Prerequisites
- Running Crowdsec installation
~~- Running InfluxDB installation~~
- Cloudflare API key (Permissions: Zone.DNS - Edit)

#### Setup Docker container
Prepare the folder structure:
```sh
mkdir -p ~/docker/traefik/{logs, data, config}
touch ~/docker/traefik/.env
sudo chmod 600 ~/docker/traefik/.env
```

Update all variables in the .env file according to your setup.
```sh
nano ~/docker/traefik/.env

# add:
TZ=Europe/Zurich

TRAEFIK_HOST=<HOST>

DOMAINNAME_CLOUD_SERVER=<domain>
DOMAINNAME_LOCAL_SERVER=<local.domain>

CLOUDFLARE_EMAIL=<CF_EMAIL>
CLOUDFLARE_API_KEY=<CF_APIKEY>

#INFLUX_URL=https://<INFLUX_FQDN>
#INFLUX_TOKEN=<INFLUX_TOKEN>
#INFLUX_ORG=<INFLUX_OR>
#INFLUX_BUCKET=<INFLUX_BUCKET>
```

Don't forget to add the needed DNS entry (TRAEFIK_HOST.domain) for reaching the service.

#### Add Middlewares / TLS Options
The middlewares should be adjusted to your needs. I'm bunlding them to chains, which are assigned to services.
Create the following files:
| File | Purpose |
|---|---|
| ~/docker/traefik/data/rules/middlewars.yml | all the middlewares |
| ~/docker/traefik/data/rules/middlewars-chains.yml | all the middleware chains |
| ~/docker/traefik/data/rules/tls-opts.yml | tls options |

After adding the middlewares and tls options files, you can start the Docker container:
`docker compose -f ~docker/traefik/traefik-compose.yml up -d`

#### Setup Logrotation on the Docker host
`sudo nano /etc/logrotate.d/traefik`
```
/home/<username>/docker/traefik/logs/*.log
{
        su root root
        daily
        maxsize 20M
        rotate 14
        missingok
        compress
        notifempty
        dateext
        dateformat -%Y%m%d%H
        postrotate
            docker kill --signal="USR1" traefik
        endscript
}
```

Test it: `sudo logrotate -f /etc/logrotate.d/traefik --debug`
Optional: Execute it once: `sudo logrotate -f /etc/logrotate.d/traefik`

#### Increase watches
When I added too many static configuration files, the whole Traefik configuration failed and I retrieved the following error: "ERR Cannot start the provider *file.Provider error="error adding file watcher: no space left on device".
To prevent this, I had to increase the inotify watches on the host and restart traefik:
```sh
sudo sysctl fs.inotify.max_user_instances=8192
sudo sysctl fs.inotify.max_user_watches=524288
sudo sysctl -p
docker restart traefik

# make it permanent:
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
echo fs.inotify.max_user_instances=8192 | sudo tee -a /etc/sysctl.conf
```

### Setup new applications
If the Docker container is running on the same host then the Traefik container, it can dynamically be added to Traefik. For this you need to add the Docker container to the same network as Traefik ("proxy" in my place).
If the service is on a different host than the Traefik container or not a Docker container, it can be added with static configuration files.

#### With Docker Labels
- Add the following labels to the container and replace "<Service Name>" with the name of the service:
```yml
    labels:
      traefik.enable: true
      # http
      traefik.http.routers.<Service Name>-rtr.entrypoints: https
      traefik.http.routers.<Service Name>-rtr.rule: Host(`$FQDN`)
      traefik.http.routers.<Service Name>-rtr.middlewares: chain-no-auth@file  # adjust to your needs
      traefik.http.routers.<Service Name>-rtr.service: <Service Name>-svc
      traefik.http.services.<Service Name>-svc.loadbalancer.server.port: <PORT>
      # tcp
      traefik.tcp.routers.<Service Name><PORT>-rtr.entrypoints: <Service Name><PORT>
      traefik.tcp.routers.<Service Name><PORT>-rtr.rule: HostSNI(`*`)
      traefik.tcp.routers.<Service Name><PORT>-rtr.service: <Service Name><PORT>-svc
      traefik.tcp.services.<Service Name><PORT>-svc.loadbalancer.server.port: <PORT>
      # udp
      traefik.udp.routers.<Service Name><PORT>-rtr.entrypoints: <Service Name><PORT>
      traefik.udp.routers.<Service Name><PORT>-rtr.service: <Service Name><PORT>-svc
      traefik.udp.services.<Service Name><PORT>-svc.loadbalancer.server.port: <PORT>
    networks:
      - proxy

networks:
  proxy:
    external: true
```

#### With Static Files
- Add the file "app-<Service Name>.yml" to ~docker/traefik/data/rules. This example is adding an http/s entry, a tcp entry and a udp entry.
```yml
http:
  routers:
    <Service Name>-rtr:
      rule: "Host(`<HOST>.{{env "DOMAINNAME_LOCAL_SERVER"}}`)"
      entryPoints:
        - https
      middlewares:
        - chain-no-auth # adjust to your needs
      service: <Service Name>-svc

  services:
    <Service Name>-svc:
      loadBalancer:
        servers:
          - url: "http://<IP of the host>:<PORT>"

tcp:
  routers:
    <Service Name>-tcp-rtr:
      rule: "HostSNI(`*`)"
      entryPoints:
        - <Service Name><PORT>
      service: <Service Name>-tcp-svc
  services:
    <Service Name>-tcp-svc:
      loadBalancer:
        servers:
          - address: "<IP of the host>:<PORT>"

udp:
  routers:
    <Service Name>-udp-rtr:
      entryPoints:
        - <Service Name><PORT>
      service:  <Service Name>-udp-svc
  services:
     <Service Name>-udp-svc:
      loadBalancer:
        servers:
          - address: "<IP of the host>:<PORT>"
```

### Monitoring
Iâ€™m currently only using the Docker metrics for monitoring the environment. Therefore, Traefik metrics collection is disabled until I have a use case for it.

### ToDo
- Do something with the Traefik metrics
